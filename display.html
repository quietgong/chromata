<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="./assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <script src="chromata.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
  <title>Display</title>
  <style type="text/css">
    body {
      margin: 0;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      vertical-align: middle;
      background-color: black;
    }


    .displayElem {
      width: 100vw;
      height: 100vh;
      opacity: 0;
      transition: opacity 1s ease;
      position: fixed;
    }

    canvas {
      position: fixed;
    }

    .displayElem.active {
      opacity: 1;
    }

    #timer {
      position: absolute;
      top: 10%;
      left: 10%;
    }

    i {
      position: absolute;
      bottom: 10%;
      left: 10%;
    }

    i:hover {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="showDiv" class="container" style="display: none;">
    <h3 style="color: white;" id="timer"></h3>
    <img id="user" src="" class="displayElem active">
    <i id="capture" onclick="handleCaptureButtonClick()" class="fas fa-camera fa-beat fa-4x btns" style="color: #fbf9f9;"></i>
  </div>

  <div id="displayDiv" class="container" style="display: block;">
    <video id="bgvid" src="title.mp4" class="displayElem" loop autoplay muted></video>
    <img id="bg1" class="displayElem" src="image1.jpg">
    <img id="bg2" class="displayElem" src="image2.jpg">
    <img id="bg3" class="displayElem" src="image3.jpg">
  </div>

  <script>
    // 화면 캡처, 이메일 발송
    async function handleCaptureButtonClick() {
      var chromataCanvas = document.getElementById("chromataCanvas");
      var ctx = chromataCanvas.getContext('2d');
      ctx.fillStyle = '#000000'
      ctx.fillRect(0, 0, chromataCanvas.width, chromataCanvas.height);
      let dataURL = chromataCanvas.toDataURL('image/png')
      let fileName = 'your_chromata.png'
      let arr = dataURL.split(',');
      let mime = arr[0].match(/:(.*?);/)[1];
      let bstr = atob(arr[1]);
      let n = bstr.length;
      let u8arr = new Uint8Array(n);
      while (n--)
        u8arr[n] = bstr.charCodeAt(n);
      let imageFile = new File([u8arr], fileName, { type: mime });
      let formData = new FormData();
      formData.append('file', imageFile);
      formData.append('prefix', 'tmp');
      let imgPath;
      await axios.post('https://dev-cmsapi.seobuk.kr/v1/file/upload', formData, {
        headers: {
          'Content-Type': 'multipart/form-data', // 멀티파트 형식으로 전송
        },
      }).then(function (response) {
        imgPath = response.data.content.files[0].path
      })
      let email = prompt("이미지를 받을 이메일주소 입력");
      await axios({
        method: "post",
        url: "https://3oj4pwllli.execute-api.ap-northeast-2.amazonaws.com/v1/mail",
        data: {
          "to": email,
          "src": imgPath
        },
        headers: {
          'Content-Type': 'application/json', // 멀티파트 형식으로 전송
        }
      }).then(() => {
        alert("메일을 확인해주세요!")
      })
    }

    const showDiv = document.getElementById("showDiv");
    const displayDiv = document.getElementById("displayDiv");
    const userPic = document.getElementById("user");
    const video = document.getElementById('bgvid');
    const timer = document.getElementById("timer");
    const bg1 = document.getElementById('bg1');
    const bg2 = document.getElementById('bg2');
    const bg3 = document.getElementById('bg3');
    const chromataCanvas = document.getElementById('chromataCanvas');
    const captureButton = document.getElementById("capture");

    let currentIndex = 0;
    let userChromata;
    let displayChromata;
    let displayArray = [video, bg1, bg2, bg3];
    let displayChromataEndInterval;

    const displayTime = 10*1000 // 크로마타 이미지 출력 시간
    const beforeChromataTime = 3*1000 // 크로마타 대상 이미지 출력 시간
    const remainTime = 5 // 출력 잔여 시간
    let time = beforeChromataTime + displayTime;

    showItem(currentIndex);

    window.addEventListener('message', function (event) {
      clearInterval(displayChromataEndInterval);
      switchMode();
      userPic.src = event.data.path;
      userChromata = new Chromata(userPic);
      // 5초가 남았을 때 간격으로 타이머를 표시하고자 함
      let timerInterval = setInterval(() => {
        time--;
        if (time <= remainTime)
          timer.innerHTML = time
      }, 1000); // 5초마다 타이머를 출력

      setTimeout(() => {
        userChromata.start();
        setTimeout(() => {
          userChromata.reset();
          switchMode();
          showItem(0);
          time = beforeChromataTime + displayTime;
          clearInterval(timerInterval); // 타이머 삭제
        }, displayTime); // 10초 후에 크로마타 애니메이션 종료 및 모드 전환
      }, beforeChromataTime); // 3초 후에 크로마타 애니메이션 시작
    });


    function switchMode() {
      showDiv.style.display = (showDiv.style.display === 'none') ? 'block' : 'none';
      displayDiv.style.display = (showDiv.style.display === 'none') ? 'block' : 'none';
    }

    function showItem(index) {
      displayArray.forEach((elem, i) => {
        i === index ? elem.classList.add('active') : elem.classList.remove('active');
      });
      currentIndex = index;
      if (currentIndex !== 0) {
        displayChromata.reset();
        displayChromata = new Chromata(displayArray[currentIndex]);
        setTimeout(() => {
          displayChromata.start();
        }, beforeChromataTime); // 3초 대신 5초로 변경
      }
      displayChromataEndInterval = setInterval(() => {
        showItem((currentIndex + 1) % displayArray.length);
      }, displayTime);
    }
  </script>
</body>

</html>