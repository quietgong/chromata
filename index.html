<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="chromata.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
  <title>Document</title>
  <style type="text/css">
    body {
      margin: 0;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: black;
    }

    .displayElem {
      width: 100%;
      height: 80%;
      opacity: 0;
      margin: auto;
      transition: opacity 1s ease;
      position: fixed;
    }

    .displayElem.active {
      opacity: 1;
    }

    .btns {
      display: none;
      position: absolute;
      bottom: 5%;
      /* 원하는 수직 위치 (예: 10px 아래) */
      left: 50%;
      /* 가로 중앙 */
      transform: translateX(-50%);
      /* 가로 중앙 정렬을 위한 조정 */
    }
  </style>
</head>

<body>
  <div class="container">
    <video id="bgvid" style="object-fit: cover;" src="title.mp4" class="displayElem" loop autoplay muted></video>
    <img id="bg1" class="displayElem" src="image1.jpg">
    <img id="bg2" class="displayElem" src="image2.jpg">
    <img id="bg3" class="displayElem" src="image3.jpg">
    <div id="btns">
      <button id="capture" class="btns">capture</button>
    </div>
  </div>
  <script>
    let video = document.getElementById('bgvid');
    let bg1 = document.getElementById('bg1');
    let bg2 = document.getElementById('bg2');
    let bg3 = document.getElementById('bg3');
    let displayArray = [video, bg1, bg2, bg3];
    let captureButton = document.getElementById("capture");
    let currentIndex = 0;
    let currentChromata = null;

    const nextIndex = (currentIndex + 1) % displayArray.length;
    showItem(nextIndex);

    captureButton.addEventListener("click", handleCaptureButtonClick);

    function showButtons() {
      captureButton.style.display = 'block'
    }

    function hideButtons() {
      captureButton.style.display = 'none'
    }

    function dataURLtoFile(dataURL, fileName) {
      var arr = dataURL.split(',');
      var mime = arr[0].match(/:(.*?);/)[1];
      var bstr = atob(arr[1]);
      var n = bstr.length;
      var u8arr = new Uint8Array(n);

      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }

      return new File([u8arr], fileName, { type: mime });
    }

    async function handleCaptureButtonClick() {
      var chromataCanvas = document.getElementById("chromataCanvas");
      var imageFile = dataURLtoFile(chromataCanvas.toDataURL('image/png'), 'captured_image.png'); // 데이터 URL을 파일로 변환
      var formData = new FormData();
      formData.append('file', imageFile); // 이미지 파일을 'image' 필드에 추가
      formData.append('prefix', 'tmp');
      // API 엔드포인트 및 요청 설정
      let imgPath;
      await axios.post('https://dev-cmsapi.seobuk.kr/v1/file/upload', formData, {
        headers: {
          'Content-Type': 'multipart/form-data', // 멀티파트 형식으로 전송
        },
      }).then(function (response) {
        imgPath = response.data.content.files[0].path
      })
      
      let email = prompt("이미지를 받을 이메일주소 입력");

      await axios({
        method: "post",
        url: "https://3oj4pwllli.execute-api.ap-northeast-2.amazonaws.com/v1/mail",
        data: {
          "to": email,
          "src": imgPath
        },
        headers: {
          'Content-Type': 'application/json', // 멀티파트 형식으로 전송
        }
      }).then(() => {
        console.log('Email Sent')
      })
    }

    function showItem(index) {
      hideButtons();
      displayArray.forEach((elem, i) => {
        if (i === index) {
          elem.classList.add('active');
        } else {
          elem.classList.remove('active');
        }
      });
      currentIndex = index;
      if (currentIndex !== 0) {
        if (currentChromata) {
          currentChromata.reset();
        }
        currentChromata = new Chromata(displayArray[currentIndex]);
        setTimeout(() => {
          currentChromata.start();
          showButtons();

        }, 2500);
      }
    }
    setInterval(() => {
      const nextIndex = (currentIndex + 1) % displayArray.length;
      showItem(nextIndex);
    }, 10000);
  </script>
</body>

</html>